(()=>{var P={x:0,y:0,w:920,h:440},it=.7,nt=2.4,pe=.2,st=700,ot=350,rt=[{id:"s_speed",name:"SpeedElite",unitCost:16,unitEmissions:4,reliability:95,leadTime:3,capacity:1e5},{id:"s_budget",name:"BudgetBulk",unitCost:6.5,unitEmissions:8,reliability:68,leadTime:8,capacity:3e5},{id:"s_green",name:"GreenPrime",unitCost:19,unitEmissions:1.2,reliability:92,leadTime:8,capacity:7e4},{id:"s_bal",name:"BalancePro",unitCost:10.5,unitEmissions:3.5,reliability:86,leadTime:5,capacity:18e4},{id:"s_local",name:"LocalSwift",unitCost:12.5,unitEmissions:3,reliability:89,leadTime:4,capacity:12e4},{id:"s_eco",name:"EcoValue",unitCost:9,unitEmissions:2.5,reliability:80,leadTime:9,capacity:15e4},{id:"s_mega",name:"MegaCorp",unitCost:7.5,unitEmissions:6.5,reliability:73,leadTime:8,capacity:25e4},{id:"s_prem",name:"PremiumGreen",unitCost:15,unitEmissions:1.8,reliability:93,leadTime:6,capacity:9e4}],ue=[{name:"BOM A (Simple)",description:"8-node BOM. Learn decoupling points and supplier trade-offs.",fgId:"FG_A",fgDemand:1250,targetCost:165e3,targetEmissions:48e3,targetInventoryEmissions:4800,serviceTarget:16,objective:{cost:420,emissions:220,inventoryEmissions:90,reliability:2.4,service:2.2},nodes:[{id:"FG_A",name:"City Bike",type:"FG",leadTime:4,holdingRate:1.2,internalEmission:.9,x:70,y:160},{id:"SUB_A1",name:"Frame Assembly",type:"SUB",leadTime:3,holdingRate:.8,internalEmission:.5,x:280,y:100},{id:"SUB_A2",name:"Power Assembly",type:"SUB",leadTime:3,holdingRate:.85,internalEmission:.45,x:280,y:230},{id:"P_A4",name:"Aluminum Shell",type:"PURCHASED",leadTime:5,holdingRate:.5,internalEmission:0,x:525,y:60},{id:"P_A3",name:"Battery",type:"PURCHASED",leadTime:8,holdingRate:.7,internalEmission:0,x:525,y:145},{id:"P_A1",name:"Motor",type:"PURCHASED",leadTime:7,holdingRate:.6,internalEmission:0,x:525,y:210},{id:"P_A2",name:"Control Board",type:"PURCHASED",leadTime:6,holdingRate:.55,internalEmission:0,x:525,y:280},{id:"P_A5",name:"Fastener Kit",type:"PURCHASED",leadTime:4,holdingRate:.35,internalEmission:0,x:780,y:160}],edges:[{parent:"FG_A",child:"SUB_A1",qty:1},{parent:"FG_A",child:"SUB_A2",qty:1},{parent:"FG_A",child:"P_A3",qty:1},{parent:"FG_A",child:"P_A5",qty:4},{parent:"SUB_A1",child:"P_A4",qty:1},{parent:"SUB_A2",child:"P_A1",qty:1},{parent:"SUB_A2",child:"P_A2",qty:1}],supplierIds:["s_speed","s_budget","s_bal","s_local","s_eco"]},{name:"BOM B (Medium)",description:"14-node BOM, 2 levels deep. Position buffers where flow bottlenecks appear.",fgId:"FG_B",fgDemand:980,targetCost:22e4,targetEmissions:23e3,targetInventoryEmissions:6200,serviceTarget:18,objective:{cost:250,emissions:390,inventoryEmissions:110,reliability:2.2,service:2.1},nodes:[{id:"FG_B",name:"Smart Pump",type:"FG",leadTime:4,holdingRate:1.3,internalEmission:1.1,x:60,y:180},{id:"SUB_B1",name:"Hydraulic Block",type:"SUB",leadTime:3,holdingRate:.9,internalEmission:.7,x:245,y:60},{id:"SUB_B2",name:"Control Block",type:"SUB",leadTime:3,holdingRate:.95,internalEmission:.6,x:245,y:180},{id:"SUB_B3",name:"Housing Block",type:"SUB",leadTime:2,holdingRate:.85,internalEmission:.45,x:245,y:300},{id:"P_B1",name:"Rotor",type:"PURCHASED",leadTime:8,holdingRate:.65,internalEmission:0,x:470,y:15},{id:"P_B2",name:"Seal Kit",type:"PURCHASED",leadTime:5,holdingRate:.4,internalEmission:0,x:470,y:60},{id:"P_B8",name:"Valve",type:"PURCHASED",leadTime:6,holdingRate:.45,internalEmission:0,x:470,y:105},{id:"P_B3",name:"Sensor",type:"PURCHASED",leadTime:6,holdingRate:.45,internalEmission:0,x:470,y:155},{id:"P_B4",name:"Microcontroller",type:"PURCHASED",leadTime:9,holdingRate:.6,internalEmission:0,x:470,y:200},{id:"P_B5",name:"Wiring Loom",type:"PURCHASED",leadTime:4,holdingRate:.35,internalEmission:0,x:470,y:245},{id:"P_B9",name:"Actuator",type:"PURCHASED",leadTime:8,holdingRate:.55,internalEmission:0,x:710,y:200},{id:"P_B6",name:"Casting",type:"PURCHASED",leadTime:7,holdingRate:.5,internalEmission:0,x:470,y:295},{id:"P_B7",name:"Cover Plate",type:"PURCHASED",leadTime:5,holdingRate:.35,internalEmission:0,x:470,y:340},{id:"P_B10",name:"Connector Set",type:"PURCHASED",leadTime:4,holdingRate:.32,internalEmission:0,x:710,y:320}],edges:[{parent:"FG_B",child:"SUB_B1",qty:1},{parent:"FG_B",child:"SUB_B2",qty:1},{parent:"FG_B",child:"SUB_B3",qty:1},{parent:"SUB_B1",child:"P_B1",qty:1},{parent:"SUB_B1",child:"P_B2",qty:2},{parent:"SUB_B1",child:"P_B8",qty:2},{parent:"SUB_B2",child:"P_B3",qty:2},{parent:"SUB_B2",child:"P_B4",qty:1},{parent:"SUB_B2",child:"P_B5",qty:1},{parent:"SUB_B2",child:"P_B9",qty:1},{parent:"SUB_B3",child:"P_B6",qty:1},{parent:"SUB_B3",child:"P_B7",qty:1},{parent:"SUB_B3",child:"P_B10",qty:3}],supplierIds:["s_speed","s_green","s_bal","s_local","s_eco","s_prem"]},{name:"BOM C (Max 20)",description:"20-node BOM, 3 levels. Keep responsiveness while controlling inventory cost.",fgId:"FG_C",fgDemand:820,targetCost:24e4,targetEmissions:33500,targetInventoryEmissions:7600,serviceTarget:22,objective:{cost:330,emissions:320,inventoryEmissions:120,reliability:2.3,service:2.2},nodes:[{id:"FG_C",name:"Autonomous Cart",type:"FG",leadTime:5,holdingRate:1.35,internalEmission:1.3,x:45,y:185},{id:"SUB_C1",name:"Drive Train",type:"SUB",leadTime:3,holdingRate:.95,internalEmission:.8,x:200,y:60},{id:"SUB_C2",name:"Control Core",type:"SUB",leadTime:4,holdingRate:1,internalEmission:.85,x:200,y:150},{id:"SUB_C3",name:"Body Frame",type:"SUB",leadTime:3,holdingRate:.9,internalEmission:.7,x:200,y:240},{id:"SUB_C4",name:"Battery Pack",type:"SUB",leadTime:3,holdingRate:.95,internalEmission:.75,x:200,y:330},{id:"SUB_C5",name:"Motor Module",type:"SUB",leadTime:2,holdingRate:.75,internalEmission:.45,x:390,y:25},{id:"SUB_C6",name:"Wheel Module",type:"SUB",leadTime:2,holdingRate:.7,internalEmission:.4,x:390,y:95},{id:"SUB_C7",name:"PCB Module",type:"SUB",leadTime:2,holdingRate:.75,internalEmission:.48,x:390,y:165},{id:"SUB_C8",name:"Enclosure Module",type:"SUB",leadTime:2,holdingRate:.7,internalEmission:.35,x:390,y:245},{id:"P_C1",name:"Copper Coil",type:"PURCHASED",leadTime:8,holdingRate:.58,internalEmission:0,x:590,y:5},{id:"P_C2",name:"Magnet Set",type:"PURCHASED",leadTime:7,holdingRate:.54,internalEmission:0,x:590,y:45},{id:"P_C3",name:"Gear Kit",type:"PURCHASED",leadTime:6,holdingRate:.48,internalEmission:0,x:590,y:85},{id:"P_C4",name:"Wheel Set",type:"PURCHASED",leadTime:5,holdingRate:.45,internalEmission:0,x:590,y:125},{id:"P_C5",name:"Sensor PCB",type:"PURCHASED",leadTime:8,holdingRate:.52,internalEmission:0,x:590,y:165},{id:"P_C6",name:"CPU Board",type:"PURCHASED",leadTime:9,holdingRate:.66,internalEmission:0,x:590,y:205},{id:"P_C7",name:"Aluminum Panel",type:"PURCHASED",leadTime:6,holdingRate:.43,internalEmission:0,x:590,y:245},{id:"P_C8",name:"Polymer Cover",type:"PURCHASED",leadTime:5,holdingRate:.4,internalEmission:0,x:590,y:285},{id:"P_C9",name:"Cell Module",type:"PURCHASED",leadTime:8,holdingRate:.62,internalEmission:0,x:430,y:310},{id:"P_C10",name:"BMS Chip",type:"PURCHASED",leadTime:9,holdingRate:.6,internalEmission:0,x:430,y:350},{id:"P_C11",name:"Harness Set",type:"PURCHASED",leadTime:4,holdingRate:.36,internalEmission:0,x:430,y:390}],edges:[{parent:"FG_C",child:"SUB_C1",qty:1},{parent:"FG_C",child:"SUB_C2",qty:1},{parent:"FG_C",child:"SUB_C3",qty:1},{parent:"FG_C",child:"SUB_C4",qty:1},{parent:"SUB_C1",child:"SUB_C5",qty:1},{parent:"SUB_C1",child:"SUB_C6",qty:2},{parent:"SUB_C2",child:"SUB_C7",qty:1},{parent:"SUB_C3",child:"SUB_C8",qty:1},{parent:"SUB_C5",child:"P_C1",qty:1},{parent:"SUB_C5",child:"P_C2",qty:2},{parent:"SUB_C5",child:"P_C3",qty:1},{parent:"SUB_C6",child:"P_C4",qty:2},{parent:"SUB_C7",child:"P_C5",qty:2},{parent:"SUB_C7",child:"P_C6",qty:1},{parent:"SUB_C8",child:"P_C7",qty:2},{parent:"SUB_C8",child:"P_C8",qty:2},{parent:"SUB_C4",child:"P_C9",qty:4},{parent:"SUB_C4",child:"P_C10",qty:1},{parent:"SUB_C4",child:"P_C11",qty:2}],supplierIds:["s_speed","s_budget","s_green","s_bal","s_local","s_eco","s_mega","s_prem"]}];function ie(e,t){let n=Math.max(1,t);return e/n}function j(e,t,n,o){let r=Math.max(0,t),a=Math.max(0,n),d=Math.max(0,o),c=e*r*a,p=c*d,m=c+p,u=e*r,v=u,y=m+u+v;return{redBase:c,redSafety:p,red:m,yellow:u,green:v,topOfGreen:y}}function at(e,t,n,o){return e<t?"Red":e<t+n?"Yellow":e<o?"Green":"Above Green"}function $e(e){return e.topOfGreen/2}function ne(e,t,n,o){let r={},a={};e.forEach(p=>{r[p.id]=[],a[p.id]=0}),t.forEach(p=>{r[p.parent].push(p),a[p.child]+=1});let d={};e.forEach(p=>{d[p.id]=0}),d[n]=o;let c=[];for(Object.keys(a).forEach(p=>{a[p]===0&&c.push(p)});c.length;){let p=c.shift(),m=d[p]||0;r[p].forEach(u=>{d[u.child]+=m*u.qty,a[u.child]-=1,a[u.child]===0&&c.push(u.child)})}return d}function De(e,t,n,o,r){return e===o?r:n.filter(a=>a.child===e).reduce((a,d)=>a+(t[d.parent]||0)*d.qty,0)}function se(e,t,n,o){let r={},a=d=>{if(r[d]!=null)return r[d];let c=0,p=t[d]||[];for(let m=0;m<p.length;m+=1){let u=p[m].child;o[u]||(c=Math.max(c,a(u)))}return r[d]=Math.max(0,n[d]||0)+c,r[d]};return e.forEach(d=>a(d)),r}function oe(e,t){let n={};return e.forEach(o=>{n[o]=[]}),t.forEach(o=>{n[o.child]||(n[o.child]=[]),n[o.child].push(o.parent)}),n}function re(e,t){let n={};return e.forEach(o=>{n[o]=0}),t.forEach(o=>{n[o.child]=(n[o.child]||0)+1}),n}function ae(e,t,n){let o=[],r={...n},a=[e],d=new Set;for(;a.length;){let c=a.shift();if(d.has(c))continue;d.add(c),o.push(c),(t[c]||[]).forEach(m=>{let u=m.child;r[u]-=1,r[u]===0&&a.push(u)})}return o}function z(e,t,n,o,r){let a={};return e.forEach(d=>{if(d===r){a[d]=Math.max(0,n[d]||0);return}let c=t[d]||[],p=0;c.forEach(m=>{let u=a[m]??0,v=o[m]?0:u;v>p&&(p=v)}),a[d]=Math.max(0,n[d]||0)+p}),a}function K(e,t){let n=e.map(m=>t[m]).filter(Boolean);if(!n.length)return{valid:!1,selectedCount:0,effCost:18,effEmissions:7,effLeadTime:12,effReliability:50};let o=n.length,r=1/o,a=n.reduce((m,u)=>m+u.unitCost*r,0),d=n.reduce((m,u)=>m+u.unitEmissions*r,0),c=n.reduce((m,u)=>Math.max(m,u.leadTime),0),p=n.reduce((m,u)=>Math.min(m,u.reliability),100);return{valid:!0,selectedCount:o,effCost:a,effEmissions:d,effLeadTime:c,effReliability:p}}function Fe(e){return Number.isFinite(e.invEmisFactor)?e.invEmisFactor:Math.max(.01,(e.holdingRate||.2)*.2)}var s={scenarioIndex:0,selectedNodeId:null,supplierAssignments:{},buffers:{},netFlowInputs:{},finalDemand:1e3,periodDays:30,history:{cost:{current:[],opt:[]},emissions:{current:[],opt:[]}},lastTotals:null,lastScore:0,optimized:null,roundActive:!1,animFrames:{},modalHandlers:{primary:null,secondary:null},tipFlags:{firstBufferChange:!1,firstSupplierChoice:!1,flowImproved:!1,inventorySpike:!1},bomRefs:{},advisor:{enabled:!0,timer:0},layout:{userInspectorChoice:!1,inspectorCollapsed:!1},ui:{nodeSearchQuery:"",zoomLevel:1,panX:0,panY:0,bomDragStart:null,bomDidPan:!1}},B=()=>ue[s.scenarioIndex],G=()=>{let e={};return B().nodes.forEach(t=>{e[t.id]=t}),e},me=()=>{let e=new Set(B().supplierIds),t={};return rt.forEach(n=>{e.has(n.id)&&(t[n.id]=n)}),t},Le=()=>B().nodes.filter(e=>e.type==="PURCHASED"),Ne=()=>{let e=G();return!!s.selectedNodeId&&e[s.selectedNodeId]?.type==="PURCHASED"},Ue=(e,t)=>{let n=t.trim().toLowerCase();return n?e.name.toLowerCase().includes(n)||e.id.toLowerCase().includes(n):!1},Re=()=>{let e={};return B().nodes.forEach(t=>{e[t.id]=[]}),B().edges.forEach(t=>{e[t.parent].push(t)}),e},dt=(e=null)=>e||{supplierAssignments:s.supplierAssignments,buffers:s.buffers,netFlowInputs:s.netFlowInputs,finalDemand:s.finalDemand,periodDays:s.periodDays},F=e=>({supplierAssignments:Object.fromEntries(Object.entries(e.supplierAssignments||{}).map(([t,n])=>[t,[...n||[]]])),buffers:Object.fromEntries(Object.entries(e.buffers||{}).map(([t,n])=>[t,{...n||{}}])),netFlowInputs:Object.fromEntries(Object.entries(e.netFlowInputs||{}).map(([t,n])=>[t,{...n||{}}])),finalDemand:e.finalDemand??1e3,periodDays:e.periodDays??30}),fe=()=>F({supplierAssignments:s.supplierAssignments,buffers:s.buffers,netFlowInputs:s.netFlowInputs,finalDemand:s.finalDemand,periodDays:s.periodDays});var he=(e,t,n)=>Math.min(Math.max(e,t),n);function N(e=null){let t=B(),n=dt(e),o=me(),r=Re(),a=t.nodes.map(S=>S.id),d=ne(t.nodes,t.edges,t.fgId,n.finalDemand),c=0,p=0,m=0,u=0,v=0,y=0,E=0,M=0,H=0,ee=0,q=0,U=0,h={},g={},C={},b={};t.nodes.forEach(S=>{b[S.id]=!!n.buffers[S.id]?.buffered;let O=S.leadTime;if(S.type==="PURCHASED"){let le=n.supplierAssignments[S.id]||[],te=K(le,o);C[S.id]=te,O=S.leadTime+te.effLeadTime}h[S.id]=O});let w=oe(a,t.edges),A=re(a,t.edges),$=ae(t.fgId,r,A),V=z($,w,h,b,t.fgId),Y=z($,w,h,{},t.fgId),D=se(a,r,h,{}),I=se(a,r,h,b);t.nodes.forEach(S=>{let O=d[S.id],le=ie(O,n.periodDays),te=I[S.id]||0,ce=!!b[S.id],T={redBase:0,redSafety:0,red:0,yellow:0,green:0,topOfGreen:0};ce&&(T=j(le,te,1,.35),M+=1,p+=$e(T)*S.holdingRate,H+=T.red,ee+=T.yellow,q+=T.green);let Ke=$e(T),Ze=n.netFlowInputs[S.id]||{onHandPct:100,openSupplyPct:0},Qe=ce?le*Math.min(n.periodDays,te):0,Je=Ze.onHandPct/100*T.topOfGreen,et=Ze.openSupplyPct/100*T.topOfGreen,tt=Je+et-Qe,Rt=ce?at(tt,T.red,T.yellow,T.topOfGreen):"Pass-through";if(S.type==="PURCHASED"){let Ae=C[S.id];c+=O*Ae.effCost,m+=O*Ae.effEmissions,y+=Ae.effReliability*O,E+=O,Ae.valid||(U+=1)}else u+=O*(S.internalEmission||0);ce&&(v+=Ke*Fe(S)),g[S.id]={req:O,adu:le,dlt:te,rawDlt:D[S.id]||0,buffered:ce,...T,avgInv:Ke,onHand:Je,openSupply:et,qualifiedDemand:Qe,netFlowPosition:tt,status:Rt,invEmisFactor:Fe(S)}});let L=E>0?y/E:0,Ee=$.map(S=>V[S]||0),je=$.map(S=>Y[S]||0),xe=je.length?Math.max(...je):0,Me=b[t.fgId]?0:Ee.length?Math.max(...Ee):0,xt=xe>0?he((xe-Me)/xe*100,0,95):0,At=Math.max(0,76-L)*130+Math.max(0,Me-(t.serviceTarget||12))*350+U*2e4,Lt=m+u+v;return{cost:c+p+At,emissions:Lt,reliability:L,serviceLead:Me,rawLead:xe,flowResponsiveness:xt,bufferCount:M,purchasedCost:c,inventoryCost:p,postureRed:H,postureYellow:ee,postureGreen:q,inventoryEmissions:v,required:d,nodeStats:g,supplierSummary:C,invalidSupplierNodes:U}}function ge(e){let t=B();if(e.cost<=0||e.emissions<=0)return 0;let n=he(e.cost/t.targetCost,0,2),o=he(e.emissions/t.targetEmissions,0,2),r=he(e.inventoryEmissions/Math.max(1,t.targetInventoryEmissions||1),0,2),a=t.objective||{cost:330,emissions:320,inventoryEmissions:120,reliability:2.3,service:4.4},d=1e3-n*a.cost-o*a.emissions-r*a.inventoryEmissions+e.reliability*a.reliability-e.serviceLead*a.service;return Math.round(he(d,0,1e3))}function ze(e){return e>=850?5:e>=700?4:e>=550?3:e>=400?2:1}function Ge(e){return e>=700?{label:"Approved",cls:"approved"}:e>=500?{label:"Needs Review",cls:"needs-review"}:{label:"Rejected",cls:"rejected"}}function lt(e){let t=B(),n=t.supplierIds[0];t.nodes.forEach(o=>{if(o.type!=="PURCHASED")return;!(e.supplierAssignments[o.id]||[]).length&&n&&(e.supplierAssignments[o.id]=[n])})}function ye(e){let t=N(e),n=ge(t);return{totals:t,score:n}}function wt(e){let t=B(),n=[];return t.nodes.forEach(o=>{let r=!!e.buffers[o.id]?.buffered;if(n.push({key:`B|${o.id}|${r?"off":"on"}`,kind:"buffer",nodeId:o.id,buffered:!r}),o.type!=="PURCHASED")return;let a=e.supplierAssignments[o.id]||[];t.supplierIds.forEach(d=>{let c=a.includes(d);c&&a.length<=1||n.push({key:`S|${o.id}|${d}|${c?"remove":"add"}`,kind:"supplier",nodeId:o.id,sid:d,op:c?"remove":"add"})})}),n.sort((o,r)=>o.key.localeCompare(r.key)),n}function It(e,t){if(t.kind==="buffer"){e.buffers[t.nodeId]={...e.buffers[t.nodeId]||{buffered:!1},buffered:t.buffered};return}if(t.kind==="supplier"){let n=[...e.supplierAssignments[t.nodeId]||[]];t.op==="add"&&!n.includes(t.sid)&&n.push(t.sid),t.op==="remove"&&n.includes(t.sid)&&n.length>1&&n.splice(n.indexOf(t.sid),1),e.supplierAssignments[t.nodeId]=n}}function _e(e){let n=F(e);lt(n);let o=ye(n),r={config:F(n),...o};for(let a=0;a<18;a+=1){let d=wt(n),c=null,p=o;if(d.forEach(m=>{let u=F(n);It(u,m),lt(u);let v=ye(u);(v.score>p.score||v.score===p.score&&c&&m.key<c.key)&&(p=v,c={...m,config:u})}),!c||p.score<=o.score)break;n=c.config,o=p,o.score>r.score&&(r={config:F(n),...o})}return{config:r.config,totals:r.totals,score:r.score,optimizedKPIs:{cost:r.totals.cost,emissions:r.totals.emissions,reliability:r.totals.reliability,serviceLT:r.totals.serviceLead,inventoryCost:r.totals.inventoryCost,inventoryEmissions:r.totals.inventoryEmissions,score:r.score}}}var ke={tooltips:[{id:"cost_metric",element:"Total Cost metric card",text:"Total cost = procurement + buffer holding. Lower is better, but watch emissions and reliability."},{id:"emissions_metric",element:"Emissions metric card",text:"Total CO\u2082 from selected suppliers. Cheaper suppliers often emit more. Buffers don't affect emissions directly."},{id:"reliability_metric",element:"Reliability metric card",text:"Average supplier reliability. Higher = fewer disruptions. Buffers boost this by 2.5% each."},{id:"lead_time_metric",element:"Lead Time metric card",text:"Average lead time across suppliers. Each buffer cuts this by ~1.2 days but adds $3,500 holding cost."},{id:"buffer_positioning",element:"Buffer checkboxes",text:"Buffers decouple variability: they reduce lead time and boost reliability, but increase holding cost."},{id:"optimization_score",element:"Optimization Score box",text:"Composite score: 40% cost efficiency, 40% emissions reduction, 20% reliability. Target 700+ for 4 stars."},{id:"scenario_picker",element:"Scenario buttons (header)",text:"Each scenario has different target thresholds and supplier pools. Test your optimization strategy across all three."},{id:"star_rating",element:"Star display",text:"\u2605\u2605\u2605\u2605\u2605 = Expert (850+), \u2605\u2605\u2605\u2605 = Proficient (700+), \u2605\u2605\u2605 = Competent (550+), \u2605\u2605 = Developing (400+), \u2605 = Needs work."}]};var Tt=new URLSearchParams(window.location.search),ve=Tt.get("test")==="1",Pt=window.matchMedia("(prefers-reduced-motion: reduce)").matches,l=e=>document.getElementById(e),f=e=>e.toLocaleString("en-US",{maximumFractionDigits:1}),Q=e=>`$${e.toLocaleString("en-US",{maximumFractionDigits:0})}`,k=(e,t,n)=>Math.min(Math.max(e,t),n),Ot=e=>Number.isFinite(e)&&!Number.isNaN(e),we=e=>`${Math.round(e)}`,i={supplierList:l("supplierList"),supplierChoicesBlock:l("supplierChoicesBlock"),supplierInlineHint:l("supplierInlineHint"),selectedCount:l("selectedCount"),purchasedCount:l("purchasedCount"),scenarioSummary:l("scenarioSummary"),demandRange:l("demandRange"),demandInput:l("demandInput"),periodDaysInput:l("periodDaysInput"),nodeSearch:l("nodeSearch"),costValue:l("metricCost"),emissionsValue:l("metricEmissions"),reliabilityValue:l("metricReliability"),leadValue:l("metricLead"),deltaCost:l("deltaCost"),deltaEmissions:l("deltaEmissions"),bufferCount:l("bufferCount"),inventoryPosture:l("inventoryPosture"),postureRed:l("postureRed"),postureYellow:l("postureYellow"),postureGreen:l("postureGreen"),scoreValue:l("scoreValue"),scoreStars:l("scoreStars"),progressFill:l("progressFill"),costLine:l("costLine"),costLineOptimized:l("costLineOptimized"),emissionsLine:l("emissionsLine"),emissionsLineOptimized:l("emissionsLineOptimized"),tooltip:l("tooltip"),modal:l("modal"),modalTitle:l("modalTitle"),modalBody:l("modalBody"),modalPrimary:l("modalPrimary"),modalSecondary:l("modalSecondary"),scenarioModal:l("scenarioModal"),indicator:l("optimizerIndicator"),boardBadge:l("boardBadge"),roundStatus:l("roundStatus"),startRoundBtn:l("startRoundBtn"),endRoundBtn:l("endRoundBtn"),optimizeBtn:l("optimizeBtn"),tutorialBtn:l("tutorialBtn"),targetCostInline:l("targetCostInline"),targetEmissionsInline:l("targetEmissionsInline"),costTargetPill:l("costTargetPill"),emissionsTargetPill:l("emissionsTargetPill"),costTargetFill:l("costTargetFill"),emissionsTargetFill:l("emissionsTargetFill"),advisorBody:l("advisorBody"),advisorThinking:l("advisorThinking"),advisorToggle:l("advisorToggle"),bomSvg:l("bomSvg"),inspectorEmpty:l("nodeInspectorEmpty"),inspectorBody:l("nodeInspectorBody"),inspectorName:l("inspectorName"),inspectorType:l("inspectorType"),inspectorDemand:l("inspectorDemand"),inspectorLead:l("inspectorLead"),inspectorBuffered:l("inspectorBuffered"),inspectorOnHand:l("inspectorOnHand"),inspectorOnHandValue:l("inspectorOnHandValue"),inspectorOpenSupply:l("inspectorOpenSupply"),inspectorOpenSupplyValue:l("inspectorOpenSupplyValue"),inspectorBufferSummary:l("inspectorBufferSummary"),inspectorBufferSummaryText:l("inspectorBufferSummaryText"),inspectorSummaryRed:l("inspectorSummaryRed"),inspectorSummaryYellow:l("inspectorSummaryYellow"),inspectorSummaryGreen:l("inspectorSummaryGreen"),nodeInspector:l("nodeInspector"),inspectorAccordion:l("inspectorAccordion"),mapLeadSummary:l("mapLeadSummary"),mapBufferRed:l("mapBufferRed"),mapBufferYellow:l("mapBufferYellow"),mapBufferGreen:l("mapBufferGreen"),mapBufferDetails:l("mapBufferDetails"),validityPanel:l("validityPanel"),validityBody:l("validityBody"),runTestsBtn:l("runTestsBtn"),testResults:l("testResults"),invEmissionsValue:l("metricInvEmissions"),inventoryValue:l("metricInventory"),zoomInBtn:l("zoomInBtn"),zoomOutBtn:l("zoomOutBtn"),zoomResetBtn:l("zoomResetBtn"),tutorialPopover:l("tutorialPopover"),startTourBtn:l("startTourBtn"),optimizedKpiBlock:l("optimizedKpiBlock"),optScore:l("optScore"),applyOptimizedBtn:l("applyOptimizedBtn"),metricCostOpt:l("metricCostOpt"),metricEmissionsOpt:l("metricEmissionsOpt"),metricReliabilityOpt:l("metricReliabilityOpt"),metricLeadOpt:l("metricLeadOpt"),metricInvEmissionsOpt:l("metricInvEmissionsOpt"),metricInventoryOpt:l("metricInventoryOpt")},yt=document.querySelectorAll(".scenario-btn[data-scenario]"),Z=(e,t,n,o,r)=>{if(s.animFrames[e]&&cancelAnimationFrame(s.animFrames[e]),Pt||o<=0||Math.abs(n-t)<.2){r(n);return}let a=performance.now(),d=n-t,c=p=>{let m=k((p-a)/o,0,1),u=1-Math.pow(1-m,3);r(t+d*u),m<1&&(s.animFrames[e]=requestAnimationFrame(c))};s.animFrames[e]=requestAnimationFrame(c)},gt=({title:e,body:t,primaryText:n="Continue",secondaryText:o=null,onPrimary:r=null,onSecondary:a=null})=>{i.modalTitle.textContent=e,i.modalBody.textContent=t,i.modalPrimary.textContent=n,i.modalSecondary.textContent=o||"",i.modalSecondary.classList.toggle("hidden",!o),s.modalHandlers.primary=r,s.modalHandlers.secondary=a,i.modal.classList.remove("hidden"),i.modalPrimary.focus()},de=()=>{i.modal.classList.add("hidden"),s.modalHandlers.primary=null,s.modalHandlers.secondary=null},be=(e,t)=>gt({title:e,body:t}),vt=e=>"\u2605".repeat(e)+"\u2606".repeat(5-e),ct=({fillEl:e,pillEl:t,current:n,target:o})=>{let r=e.parentElement;if(!s.roundActive){e.style.width="0%",t.textContent="Not started",t.className="metric-pill neutral",r?.classList.remove("over");return}let a=o>0?n/o:0;e.style.width=`${Math.min(100,k(a*100,0,150))}%`;let d=a>1;r?.classList.toggle("over",d),t.textContent=d?"Over target":"On target",t.className=`metric-pill ${d?"bad":"ok"}`},Mt=()=>{let e=(y,E,M)=>{if(!y.length)return"";let H=M-E||1;return y.map((ee,q)=>{let U=q/Math.max(1,y.length-1)*300,h=110-(ee-E)/H*100;return`${U},${h}`}).join(" ")},t=s.history.cost.current,n=s.history.emissions.current,o=s.history.cost.opt,r=s.history.emissions.opt,a=[...t,...o],d=[...n,...r],c=a.length?Math.min(...a):0,p=a.length?Math.max(...a):1,m=d.length?Math.min(...d):0,u=d.length?Math.max(...d):1,v=(y,E)=>{if(!y.length)return[];if(y.length>=2&&y.length>=E)return y;let M=Math.max(2,E);return Array.from({length:M},()=>y[y.length-1])};if(i.costLine.setAttribute("points",e(t,c,p)),i.emissionsLine.setAttribute("points",e(n,m,u)),i.costLineOptimized){let y=v(o,Math.max(2,t.length));i.costLineOptimized.setAttribute("points",e(y,c,p))}if(i.emissionsLineOptimized){let y=v(r,Math.max(2,n.length));i.emissionsLineOptimized.setAttribute("points",e(y,m,u))}},$t=e=>{if(!s.lastTotals){i.deltaCost.textContent="",i.deltaEmissions.textContent="";return}let t=(n,o,r)=>{if(Math.abs(o)<1){n.textContent="No change",n.className="metric-delta neutral";return}n.textContent=`${o>0?"\u25B2":"\u25BC"} ${f(Math.abs(o))} ${r}`,n.className=`metric-delta ${o<0?"improved":"worsened"}`};t(i.deltaCost,e.cost-s.lastTotals.cost,""),t(i.deltaEmissions,e.emissions-s.lastTotals.emissions,"kg CO\u2082")},Dt=e=>{Object.keys(s.bomRefs).forEach(n=>{let o=s.bomRefs[n],r=G()[n],a=e.nodeStats[n];o.group.classList.toggle("selected",n===s.selectedNodeId),o.group.classList.toggle("buffered",!!a.buffered),o.group.classList.toggle("purchased-set",r.type==="PURCHASED"&&!!s.supplierAssignments[n]),o.group.classList.toggle("purchased-unset",r.type==="PURCHASED"&&!s.supplierAssignments[n]);let d=!!a.buffered,c=76,p=Math.max(1,a.red+a.yellow+a.green),m=d?a.red/p*c:0,u=d?a.yellow/p*c:0,v=d?a.green/p*c:0;o.zoneRed.setAttribute("x","8"),o.zoneRed.setAttribute("width",`${m}`),o.zoneYellow.setAttribute("x",`${8+m}`),o.zoneYellow.setAttribute("width",`${u}`),o.zoneGreen.setAttribute("x",`${8+m+u}`),o.zoneGreen.setAttribute("width",`${v}`),o.zoneRed.setAttribute("visibility",d?"visible":"hidden"),o.zoneYellow.setAttribute("visibility",d?"visible":"hidden"),o.zoneGreen.setAttribute("visibility",d?"visible":"hidden")})},qe=()=>{let e=s.ui.nodeSearchQuery.trim().toLowerCase(),t=B().nodes;Object.keys(s.bomRefs).forEach(o=>{let r=t.find(a=>a.id===o);s.bomRefs[o].group.classList.toggle("search-match",!!e&&!!r&&Ue(r,e))}),(i.supplierList?.querySelectorAll(".supplier-row[data-supplier-name]")??[]).forEach(o=>{let r=o.dataset.supplierName||"";o.classList.toggle("search-match",!!e&&r.includes(e))})},Ft=new Set(["supplier_action","buffer_action","netflow_action","demand_action","period_action","apply_optimized","round_start"]),bt=(e,t,n)=>{let o=B(),r=s.lastTotals||{cost:0,emissions:0,reliability:0,serviceLead:0,inventoryCost:0,inventoryEmissions:0},a=s.roundActive?st:0;i.bufferCount.textContent=e.bufferCount,i.inventoryPosture.textContent=e.inventoryCost>e.purchasedCost*.35?"Inventory Heavy":e.flowResponsiveness>35?"Responsive":"Balanced";let d=Math.max(1,e.postureRed+e.postureYellow+e.postureGreen);i.postureRed.style.width=`${e.postureRed/d*100}%`,i.postureYellow.style.width=`${e.postureYellow/d*100}%`,i.postureGreen.style.width=`${e.postureGreen/d*100}%`,Z("cost",r.cost,e.cost,a,p=>{i.costValue.textContent=Q(p)}),Z("emissions",r.emissions,e.emissions,a,p=>{i.emissionsValue.textContent=`${f(p)} kg CO\u2082`}),Z("rel",r.reliability,e.reliability,a,p=>{i.reliabilityValue.textContent=`${f(p)}%`}),Z("serviceLead",r.serviceLead,e.serviceLead,a,p=>{i.leadValue.textContent=`${f(p)} days`}),Z("inventory",r.inventoryCost,e.inventoryCost,a,p=>{i.inventoryValue&&(i.inventoryValue.textContent=Q(p))}),Z("invEmis",r.inventoryEmissions,e.inventoryEmissions,a,p=>{i.invEmissionsValue&&(i.invEmissionsValue.textContent=`${f(p)} kg CO\u2082`)}),Z("score",s.lastScore,t,a,p=>{i.scoreValue.textContent=Math.round(p)}),i.scoreStars.textContent=vt(ze(t)),i.progressFill.style.width=`${k(t/1e3*100,0,100)}%`;let c=Ge(t);i.boardBadge.textContent=c.label,i.boardBadge.className=`board-badge ${c.cls}`,i.targetCostInline.textContent=Q(o.targetCost),i.targetEmissionsInline.textContent=`${f(o.targetEmissions)} kg CO\u2082`,ct({fillEl:i.costTargetFill,pillEl:i.costTargetPill,current:e.cost,target:o.targetCost}),ct({fillEl:i.emissionsTargetFill,pillEl:i.emissionsTargetPill,current:e.emissions,target:o.targetEmissions}),$t(e),n&&Ft.has(n)&&(s.history.cost.current.push(e.cost),s.history.emissions.current.push(e.emissions),s.history.cost.current.length>14&&s.history.cost.current.shift(),s.history.emissions.current.length>14&&s.history.emissions.current.shift()),Mt(),Dt(e)},Ve=e=>{i.advisorBody.innerHTML=`<div class="advisor-empty">${e}</div>`},pt=e=>i.advisorThinking.classList.toggle("hidden",!e),Nt=e=>{let t=B(),n=Le().filter(c=>(s.supplierAssignments[c.id]||[]).length===0);if(n.length)return[{title:`Assign supplier for ${n[0].name}`,why:"Purchased nodes require at least one supplier selection.",body:"Select at least one supplier to produce valid cost, lead-time, and emissions values."}];let o=[],r=t.nodes.map(c=>({n:c,dlt:e.nodeStats[c.id].rawDlt})).filter(c=>!e.nodeStats[c.n.id].buffered&&c.n.id!==t.fgId).sort((c,p)=>p.dlt-c.dlt)[0],a=t.nodes.map(c=>({n:c,inv:e.nodeStats[c.id].avgInv*c.holdingRate})).filter(c=>e.nodeStats[c.n.id].buffered).sort((c,p)=>p.inv-c.inv)[0];e.serviceLead>e.rawLead*.75&&r?o.push({title:`Add buffer at ${r.n.name}`,why:"High critical-path segment remains unbuffered.",body:"Positioning a buffer can reduce effective lead time by decoupling upstream path length."}):a&&a.inv>e.inventoryCost*.22&&o.push({title:`Remove buffer at ${a.n.name}`,why:"This buffered node contributes a high share of holding cost.",body:"If lead-time impact is small, removing this buffer can improve cost posture."});let d=Le().filter(c=>(s.supplierAssignments[c.id]||[]).length===1).sort((c,p)=>e.required[p.id]-e.required[c.id])[0];return d&&o.push({title:`Multi-source ${d.name}`,why:"Equal quota split can diversify emissions and cost exposure.",body:"Select an additional supplier. Note: effective lead time follows the longest selected supplier lead time."}),o.length||o.push({title:"Current plan is balanced",why:"No single obvious hotspot dominates cost or emissions.",body:"Adjust one node at a time and watch score movement."}),o.slice(0,2)},Ut=e=>{if(!s.roundActive)return Ve("Start the round to see guidance.");if(!s.advisor.enabled)return Ve("Optimizer suggestions are hidden.");s.advisor.timer&&clearTimeout(s.advisor.timer),pt(!0);let t=Nt(e);s.advisor.timer=setTimeout(()=>{pt(!1),i.advisorBody.innerHTML="",t.forEach(n=>{let o=document.createElement("div");o.className="advisor-item",o.innerHTML=`
        <div class="advisor-headline">
          <span>${n.title}</span>
          <span class="advisor-why" data-tip="${n.why}">Why?</span>
        </div>
        <div class="advisor-rationale">${n.body}</div>
      `,i.advisorBody.appendChild(o)})},ot)},zt=(e,t)=>{s.roundActive&&(t==="buffer_action"&&s.lastTotals&&!s.tipFlags.flowImproved&&e.serviceLead<s.lastTotals.serviceLead-.4&&(s.tipFlags.flowImproved=!0,be("Decoupling point effect","Critical-path lead time dropped due to stronger decoupling at one or more nodes.")),t==="buffer_action"&&s.lastTotals&&!s.tipFlags.inventorySpike&&e.inventoryCost>s.lastTotals.inventoryCost*1.2&&(s.tipFlags.inventorySpike=!0,be("Inventory trade-off","Top Of Green rose significantly. Responsiveness improved, but holding cost increased.")))},Gt=e=>{if(!ve||!i.validityPanel||!i.validityBody)return;let t=B(),n=s.selectedNodeId||t.fgId,o=e.nodeStats[n],r=De(n,e.required,t.edges,t.fgId,s.finalDemand),a=Math.abs((e.required[n]||0)-r)>1e-6,d=[];[o.redBase,o.redSafety,o.red,o.yellow,o.green,o.topOfGreen].some(c=>c<0)&&d.push("Zone value below zero."),o.topOfGreen<o.red+o.yellow&&d.push("TopOfGreen < Red + Yellow."),Ot(o.adu)||d.push("ADU is NaN/invalid."),o.buffered&&o.adu>0&&o.topOfGreen<=0&&d.push("Buffered node has ADU>0 but TOG<=0."),a&&d.push("Requirement is not derived from BOM demand propagation."),i.validityBody.innerHTML=`
    <div><strong>Node:</strong> ${n}</div>
    <div>ADU=${f(o.adu)} u/day \xB7 DLT(computed)=${f(o.dlt)} \xB7 LTF=${1 .toFixed(2)} \xB7 VF=${.35.toFixed(2)} \xB7 buffered=${o.buffered}</div>
    <div>RedBase=${f(o.redBase)} \xB7 RedSafety=${f(o.redSafety)} \xB7 Red=${f(o.red)} \xB7 Yellow=${f(o.yellow)} \xB7 Green=${f(o.green)} \xB7 TopOfGreen=${f(o.topOfGreen)}</div>
    <div>NetFlowPosition=${f(o.netFlowPosition)} \xB7 Status=<strong>${o.status}</strong> \xB7 OnHand=${f(o.onHand)} \xB7 OpenSupply=${f(o.openSupply)} \xB7 QualifiedDemand=${f(o.qualifiedDemand)}</div>
    <div>ServiceLT=${f(e.serviceLead)} days \xB7 InventoryEmissions=${f(e.inventoryEmissions)} kg CO\u2082</div>
    <div>${d.length?`Warnings: ${d.join(" | ")}`:"No validity warnings."}</div>
  `},kt=()=>{let e=[],t=(h,g,C)=>e.push({name:h,pass:g,details:C}),n=j(10,5,1,.35);t("Buffered node invariant (ADU>0 => TOG>0)",n.topOfGreen>0,`tog=${f(n.topOfGreen)}`);let o={FG:[{child:"A"}],A:[{child:"RM"}],RM:[]},r=["FG","A","RM"],a={FG:2,A:3,RM:5},d=se(r,o,a,{}),c=se(r,o,a,{A:!0});t("DLT reacts to buffer positioning",d.FG!==c.FG,`noBuffer=${d.FG}, withBufferAtA=${c.FG}`);{let h=[{parent:"FG",child:"A"},{parent:"A",child:"RM"}],g=["FG","A","RM"],C={FG:[{child:"A"}],A:[{child:"RM"}],RM:[]},b=oe(g,h),w=re(g,h),A=ae("FG",C,w),V=z(A,b,{FG:2,A:3,RM:5},{},"FG"),Y=Math.max(...A.map(I=>V[I]||0)),D=Math.max(...A.map(I=>V[I]||0));t("Service LT equals unbuffered CP (no buffers)",D===Y,`serviceLT=${D}, unbufferedCP=${Y}`)}{let h=[{parent:"FG",child:"A"},{parent:"A",child:"RM"}],g=["FG","A","RM"],C={FG:[{child:"A"}],A:[{child:"RM"}],RM:[]},b=oe(g,h),w=re(g,h),A=ae("FG",C,w),$={FG:2,A:3,RM:5},V=z(A,b,$,{},"FG"),Y=z(A,b,$,{A:!0},"FG"),D=Math.max(...A.map(L=>V[L]||0)),I=Math.max(...A.map(L=>Y[L]||0));t("Adding buffer never increases service LT",I<=D,`before=${D}, after=${I}`)}let p=K(["s_fast","s_low"],{s_fast:{leadTime:4,unitCost:10,unitEmissions:3,reliability:90},s_low:{leadTime:9,unitCost:8,unitEmissions:5,reliability:70}});t("Multi-source lead time max rule",p.effLeadTime===9,`effectiveLead=${p.effLeadTime}`),t("Lead-time monotonicity with added buffer",c.FG<=d.FG,`before=${d.FG}, after=${c.FG}`);let m=B().fgId;s.buffers[m]||(s.buffers[m]={buffered:!1});let u=s.buffers[m].buffered;s.buffers[m].buffered=!0;let v=N();t("FG buffered implies service lead time 0",v.serviceLead===0,`serviceLead=${v.serviceLead}`),s.buffers[m].buffered=u;let y=ne([{id:"FG"},{id:"A"}],[{parent:"FG",child:"A",qty:2}],"FG",100),E=ne([{id:"FG"},{id:"A"}],[{parent:"FG",child:"A",qty:2}],"FG",200),M=j(ie(y.A,30),6,1,.35),H=j(ie(E.A,30),6,1,.35);t("Demand scaling linearity",Math.abs(H.topOfGreen-2*M.topOfGreen)<1e-6,`tog1=${f(M.topOfGreen)}, tog2=${f(H.topOfGreen)}`);let ee=s.scenarioIndex,q=!1,U="";for(let h=0;h<ue.length;h+=1){s.scenarioIndex=h,Se();let g=fe(),C=ye(g),b=_e(g);b?.config&&b.score>C.score&&(q=!0),U+=`${h}:${C.score}->${b?.score??"n/a"} `}s.scenarioIndex=ee,Se(),Xe(),We(),_(),t("Optimizer finds improvement in at least one scenario",q,U.trim());{let h=B(),g=h.nodes.find(C=>C.type==="PURCHASED");if(g){let C=me(),b=s.supplierAssignments[g.id]||[],w=K(b,C),A=g.leadTime+w.effLeadTime,$=N(),V=Re(),Y=h.nodes.map(L=>L.id),D={};h.nodes.forEach(L=>{D[L.id]=!!s.buffers[L.id]?.buffered});let I={};h.nodes.forEach(L=>{if(I[L.id]=L.leadTime,L.type==="PURCHASED"){let Ee=K(s.supplierAssignments[L.id]||[],C);I[L.id]=L.leadTime+Ee.effLeadTime}}),t("Additive lead time for purchased nodes",I[g.id]===A,`${g.id}: node.LT=${g.leadTime} + supplier=${w.effLeadTime} = ${A}, actual=${I[g.id]}`)}}{let h=B(),g=N(),C=g.serviceLead,b=h.nodes.filter(w=>w.id!==h.fgId&&!s.buffers[w.id]?.buffered).sort((w,A)=>(g.nodeStats[A.id]?.rawDlt||0)-(g.nodeStats[w.id]?.rawDlt||0))[0];if(b){s.buffers[b.id].buffered=!0;let A=N().serviceLead;s.buffers[b.id].buffered=!1,t("Buffer toggle changes serviceLT",A<=C,`before=${C}, after=${A} (buffered ${b.id})`)}}{let h=fe(),g=_e(h),C=fe(),b=JSON.stringify(h.supplierAssignments)===JSON.stringify(C.supplierAssignments)&&JSON.stringify(h.buffers)===JSON.stringify(C.buffers);t("Optimizer does not mutate current config",b,b?"configs match":"configs differ!")}{let h=s.history.cost.current.length,g=N(),C=ge(g);bt(g,C,"optimize_action");let b=s.history.cost.current.length;t("Optimize action does not push to current history",b===h,`before=${h}, after=${b}`)}return e},St=()=>{if(!ve||!i.testResults)return;let e=kt();i.testResults.innerHTML="",e.forEach(t=>{let n=document.createElement("div");n.className=`test-line ${t.pass?"pass":"fail"}`,n.textContent=`${t.pass?"PASS":"FAIL"} - ${t.name}: ${t.details}`,i.testResults.appendChild(n)})},Xe=()=>{let e=B();i.bomSvg.innerHTML="",s.bomRefs={},e.nodes.forEach(t=>{let n=document.createElementNS("http://www.w3.org/2000/svg","g");n.setAttribute("class","bom-node"),n.setAttribute("transform",`translate(${t.x},${t.y})`),n.setAttribute("tabindex","0"),n.setAttribute("role","button"),n.setAttribute("aria-label",`Inspect ${t.name}`),n.dataset.nodeId=t.id;let o=document.createElementNS("http://www.w3.org/2000/svg","rect");o.setAttribute("class","node-box"),o.setAttribute("width","92"),o.setAttribute("height","46"),n.appendChild(o);let r=document.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("x","8"),r.setAttribute("y","16"),r.textContent=t.name.length>13?`${t.name.slice(0,12)}\u2026`:t.name,n.appendChild(r);let a=document.createElementNS("http://www.w3.org/2000/svg","text");a.setAttribute("class","node-type"),a.setAttribute("x","8"),a.setAttribute("y","31"),a.textContent=t.type,n.appendChild(a);let d=document.createElementNS("http://www.w3.org/2000/svg","rect");d.setAttribute("class","bom-zone bom-zone-red"),d.setAttribute("x","8"),d.setAttribute("y","2"),d.setAttribute("width","0"),d.setAttribute("height","4"),d.setAttribute("visibility","hidden"),n.appendChild(d);let c=document.createElementNS("http://www.w3.org/2000/svg","rect");c.setAttribute("class","bom-zone bom-zone-yellow"),c.setAttribute("x","8"),c.setAttribute("y","2"),c.setAttribute("width","0"),c.setAttribute("height","4"),c.setAttribute("visibility","hidden"),n.appendChild(c);let p=document.createElementNS("http://www.w3.org/2000/svg","rect");p.setAttribute("class","bom-zone bom-zone-green"),p.setAttribute("x","8"),p.setAttribute("y","2"),p.setAttribute("width","0"),p.setAttribute("height","4"),p.setAttribute("visibility","hidden"),n.appendChild(p),n.addEventListener("click",m=>{if(s.ui.bomDidPan){m.preventDefault(),m.stopPropagation(),s.ui.bomDidPan=!1;return}ut(t.id)}),n.addEventListener("keydown",m=>{(m.key==="Enter"||m.key===" ")&&(m.preventDefault(),ut(t.id))}),i.bomSvg.appendChild(n),s.bomRefs[t.id]={group:n,zoneRed:d,zoneYellow:c,zoneGreen:p}}),e.edges.forEach((t,n)=>{let o=e.nodes.find(E=>E.id===t.parent),r=e.nodes.find(E=>E.id===t.child);if(!o||!r)return;let a=o.x+92,d=o.y+23,c=r.x,p=r.y+23,m=(n%5-2)*6,u=(a+c)/2+m,v=document.createElementNS("http://www.w3.org/2000/svg","path");v.setAttribute("d",`M ${a} ${d} C ${u} ${d}, ${u} ${p}, ${c} ${p}`),v.setAttribute("class","bom-edge"),i.bomSvg.appendChild(v);let y=document.createElementNS("http://www.w3.org/2000/svg","text");y.setAttribute("x",`${u}`),y.setAttribute("y",`${(d+p)/2-4}`),y.setAttribute("class","bom-edge-label"),y.textContent=`x${t.qty}`,i.bomSvg.appendChild(y)}),Oe()},Ht=()=>{let e=Le(),t=e.filter(u=>(s.supplierAssignments[u.id]||[]).length>0).length;i.selectedCount.textContent=t,i.purchasedCount.textContent=e.length;let n=Ne();if(i.supplierChoicesBlock&&i.supplierChoicesBlock.classList.toggle("hidden",!n),i.supplierInlineHint&&i.supplierInlineHint.classList.toggle("hidden",n),!n){i.supplierList.innerHTML="";return}let o=B().supplierIds.map(u=>me()[u]).filter(Boolean),r=G()[s.selectedNodeId],a=s.supplierAssignments[r.id]||[],c=s.optimized?.optimizedConfig?.selectedSuppliersByNode?.[r.id]||[],p=c.length,m=p?`Opt 1/${p}`:"";i.supplierList.innerHTML=`
    <div class="supplier-header">
      <span></span><span></span><span>Cost</span><span>Emis</span><span>LT</span><span>Rel</span>
    </div>
  `,o.forEach(u=>{let v=a.includes(u.id),y=c.includes(u.id),E=document.createElement("label");E.className=`supplier-row ${v?"selected":""}`,E.dataset.supplierName=u.name.toLowerCase(),E.innerHTML=`
      <input type="checkbox" data-supplier="${u.id}" ${v?"checked":""} ${s.roundActive?"":"disabled"} />
      <span class="supplier-name-wrap">
        <span class="supplier-name">${u.name}</span>
        ${y?`<span class="optMark" aria-label="Optimal supplier">\u2713</span><span class="optQuota">${m}</span>`:""}
      </span>
      <span class="sup-stat">${Q(u.unitCost)}</span>
      <span class="sup-stat">${f(u.unitEmissions)}</span>
      <span class="sup-stat">${u.leadTime}d</span>
      <span class="sup-stat">${u.reliability}%</span>
    `,i.supplierList.appendChild(E)})},qt=e=>{let t=G()[s.selectedNodeId];if(!t){i.inspectorEmpty.classList.toggle("hidden",s.layout.inspectorCollapsed),i.inspectorBody.classList.add("hidden"),i.inspectorBufferSummary&&i.inspectorBufferSummary.classList.add("hidden");return}i.inspectorEmpty.classList.add("hidden"),i.inspectorBody.classList.toggle("hidden",s.layout.inspectorCollapsed);let n=e.required[t.id],o=e.nodeStats[t.id],r=s.buffers[t.id],a=s.netFlowInputs[t.id];if(i.inspectorName.textContent=t.name,i.inspectorType.textContent=t.type,i.inspectorDemand.textContent=f(n),i.inspectorLead.textContent=`${t.leadTime} days`,i.inspectorBuffered.checked=!!r.buffered,i.inspectorOnHand.value=a.onHandPct,i.inspectorOnHandValue.textContent=`${a.onHandPct}%`,i.inspectorOpenSupply.value=a.openSupplyPct,i.inspectorOpenSupplyValue.textContent=`${a.openSupplyPct}%`,o.buffered){let d=Math.max(1,o.red+o.yellow+o.green),c=o.red/d*100,p=o.yellow/d*100,m=o.green/d*100;i.inspectorBufferSummary&&i.inspectorBufferSummary.classList.remove("hidden"),i.inspectorBufferSummaryText&&(i.inspectorBufferSummaryText.textContent=`Buffer ON \xB7 ADU ${f(o.adu)} u/day \xB7 R/Y/G ${we(o.red)}/${we(o.yellow)}/${we(o.green)} \xB7 TOG ${we(o.topOfGreen)}`),i.inspectorSummaryRed&&(i.inspectorSummaryRed.style.width=`${c}%`),i.inspectorSummaryYellow&&(i.inspectorSummaryYellow.style.width=`${p}%`),i.inspectorSummaryGreen&&(i.inspectorSummaryGreen.style.width=`${m}%`)}else i.inspectorBufferSummary&&i.inspectorBufferSummary.classList.add("hidden")},Vt=e=>{let t=G()[s.selectedNodeId];if(!t||!i.mapBufferDetails)return;let n=e.nodeStats[t.id],o=Math.max(1,n.topOfGreen),r=n.red/o*100,a=n.yellow/o*100,d=n.green/o*100;i.mapBufferRed.style.width=`${r}%`,i.mapBufferYellow.style.width=`${a}%`,i.mapBufferGreen.style.width=`${d}%`;let c=t.leadTime;if(t.type==="PURCHASED"){let p=e.supplierSummary[t.id];p&&(c=p.effLeadTime)}i.mapLeadSummary.textContent=`Commercial LT: ${f(c)}d`,i.mapBufferDetails.textContent=n.buffered?`ADU ${f(n.adu)} u/day \xB7 R/Y/G ${f(n.red)}/${f(n.yellow)}/${f(n.green)} \xB7 TOG ${f(n.topOfGreen)} \xB7 NetFlow ${f(n.netFlowPosition)} (${n.status})`:`ADU ${f(n.adu)} u/day \xB7 Buffer OFF (pass-through)`},We=()=>{yt.forEach(e=>{let t=Number(e.dataset.scenario)===s.scenarioIndex;e.classList.toggle("active",t),e.setAttribute("aria-pressed",t)})},Ct=()=>{i.scenarioSummary&&(i.scenarioSummary.textContent="",i.scenarioSummary.classList.add("hidden"))},Bt=e=>{!i.nodeInspector||!i.inspectorAccordion||(s.layout.inspectorCollapsed=e,s.selectedNodeId?(i.inspectorEmpty.classList.add("hidden"),i.inspectorBody.classList.toggle("hidden",e)):(i.inspectorEmpty.classList.toggle("hidden",e),i.inspectorBody.classList.add("hidden")),i.inspectorAccordion.setAttribute("aria-expanded",String(!e)),i.inspectorAccordion.setAttribute("aria-label",e?"Expand inspector":"Collapse inspector"),i.inspectorAccordion.textContent=e?"\u25B4":"\u25BE")},Et=()=>{s.layout.userInspectorChoice||Bt(!1)},Oe=()=>{let e=s.ui.zoomLevel,t=P.w/e,n=P.h/e,o=P.x+P.w/2,r=P.y+P.h/2,a=o-t/2-s.ui.panX,d=r-n/2-s.ui.panY;a=k(a,0,Math.max(0,P.w-t)),d=k(d,0,Math.max(0,P.h-n)),i.bomSvg.setAttribute("viewBox",`${a} ${d} ${t} ${n}`)},Ie=e=>{s.ui.zoomLevel=k(e,it,nt),Oe()},Yt=()=>{s.ui.panX=0,s.ui.panY=0,Ie(1)},Xt=e=>{s.ui.nodeSearchQuery=(e||"").trim().toLowerCase();let t=s.ui.nodeSearchQuery;if(!t){qe();return}let n=B().nodes.find(r=>Ue(r,t));if(n){s.selectedNodeId!==n.id&&(s.selectedNodeId=n.id,_());let r=s.bomRefs[n.id];r?.group&&r.group.focus()}qe();let o=i.supplierList.querySelector(".supplier-row.search-match");o&&o.scrollIntoView({block:"nearest"})},Te=()=>{!i.tutorialPopover||!i.tutorialBtn||(i.tutorialPopover.classList.add("hidden"),i.tutorialBtn.setAttribute("aria-expanded","false"))},Wt=()=>{if(!i.tutorialPopover||!i.tutorialBtn)return;let e=i.tutorialPopover.classList.contains("hidden");i.tutorialPopover.classList.toggle("hidden",!e),i.tutorialBtn.setAttribute("aria-expanded",String(e))},jt=()=>{let e=[i.metricCostOpt,i.metricEmissionsOpt,i.metricReliabilityOpt,i.metricLeadOpt,i.metricInvEmissionsOpt,i.metricInventoryOpt];if(!s.optimized){e.forEach(n=>{n&&n.classList.add("hidden")}),i.optimizedKpiBlock&&i.optimizedKpiBlock.classList.add("hidden");return}let t=s.optimized.kpiSnapshot||s.optimized.optimizedKPIs;i.metricCostOpt&&(i.metricCostOpt.textContent=Q(t.cost),i.metricCostOpt.classList.remove("hidden")),i.metricEmissionsOpt&&(i.metricEmissionsOpt.textContent=`${f(t.emissions)} kg`,i.metricEmissionsOpt.classList.remove("hidden")),i.metricReliabilityOpt&&(i.metricReliabilityOpt.textContent=`${f(t.reliability)}%`,i.metricReliabilityOpt.classList.remove("hidden")),i.metricLeadOpt&&(i.metricLeadOpt.textContent=`${f(t.serviceLT)}d`,i.metricLeadOpt.classList.remove("hidden")),i.metricInvEmissionsOpt&&(i.metricInvEmissionsOpt.textContent=`${f(t.inventoryEmissions)} kg`,i.metricInvEmissionsOpt.classList.remove("hidden")),i.metricInventoryOpt&&(i.metricInventoryOpt.textContent=Q(t.inventoryCost),i.metricInventoryOpt.classList.remove("hidden")),i.optScore&&(i.optScore.textContent=`${Math.round(t.score)}`),i.optimizedKpiBlock&&i.optimizedKpiBlock.classList.remove("hidden")},_=(e=null)=>{let t=N(),n=ge(t);bt(t,n,e),qt(t),Vt(t),Ht(),jt(),Gt(t),zt(t,e),e&&e!=="optimize_action"&&Ut(t),s.lastTotals=t,s.lastScore=n,qe()},Se=()=>{let e=B();s.selectedNodeId=e.fgId,s.supplierAssignments={},s.buffers={},s.netFlowInputs={},s.finalDemand=e.fgDemand,s.periodDays=30;let t=e.supplierIds[0]||null;e.nodes.forEach(n=>{s.buffers[n.id]={buffered:!1},n.type==="PURCHASED"&&t&&(s.supplierAssignments[n.id]=[t]),s.netFlowInputs[n.id]={onHandPct:100,openSupplyPct:0}}),s.history.cost.current=[],s.history.cost.opt=[],s.history.emissions.current=[],s.history.emissions.opt=[],s.lastTotals=null,s.lastScore=0,s.optimized=null,s.tipFlags.firstBufferChange=!1,s.tipFlags.firstSupplierChoice=!1,s.tipFlags.flowImproved=!1,s.tipFlags.inventorySpike=!1,i.demandRange&&(i.demandRange.value=`${s.finalDemand}`),i.demandInput&&(i.demandInput.value=`${s.finalDemand}`),i.periodDaysInput&&(i.periodDaysInput.value=`${s.periodDays}`),s.ui.zoomLevel=1,s.ui.panX=0,s.ui.panY=0,i.nodeSearch&&(i.nodeSearch.value=""),s.ui.nodeSearchQuery="",Ve(s.advisor.enabled?"Start the round to see guidance.":"Optimizer suggestions are hidden.")},ut=e=>{s.selectedNodeId=e,_()},Kt=e=>{if(!Ne())return;let t=s.selectedNodeId,n=[...s.supplierAssignments[t]||[]],o=n.indexOf(e);if(o>=0){if(n.length===1){be("At least one supplier required","Each supplied SKU must keep at least one selected supplier."),_();return}n.splice(o,1)}else n.push(e);s.supplierAssignments[t]=n,J(),s.tipFlags.firstSupplierChoice||(s.tipFlags.firstSupplierChoice=!0,be("Multi-sourcing enabled","Purchased nodes can select multiple suppliers with equal quota split. Longest supplier lead time governs the node lead time.")),_("supplier_action")},Zt=e=>{let t=G()[s.selectedNodeId];t&&(s.buffers[t.id]={...s.buffers[t.id],...e},J(),!s.tipFlags.firstBufferChange&&e.buffered===!0&&(s.tipFlags.firstBufferChange=!0,be("DDMRP buffer positioning","A positioned buffer creates a decoupling point. Upstream lead-time accumulation resets at this point.")),_("buffer_action"))},mt=e=>{let t=G()[s.selectedNodeId];t&&(s.netFlowInputs[t.id]={...s.netFlowInputs[t.id],...e},J(),_("netflow_action"))},ft=e=>{s.finalDemand=k(Math.round(e),1,5e3),J(),i.demandRange.value=`${s.finalDemand}`,i.demandInput.value=`${s.finalDemand}`,_("demand_action")},Qt=e=>{s.periodDays=k(Math.round(e),1,365),J(),i.periodDaysInput.value=`${s.periodDays}`,_("period_action")},ht=e=>{s.scenarioIndex=e,J(),We(),Ct(),Se(),Xe(),s.roundActive=!1,Be(!1),Ce("not-started","Round: Not started"),_()},J=()=>{s.optimized=null,s.history.cost.opt=[],s.history.emissions.opt=[]},Jt=()=>{if(!s.roundActive)return;i.indicator?.classList.remove("hidden");let e=fe(),t=ye(e),n=_e(e),o=F(n.config);o.selectedSuppliersByNode=Object.fromEntries(Object.entries(n.config.supplierAssignments||{}).map(([a,d])=>[a,[...d]]));let r={...n.optimizedKPIs};s.optimized={...n,optimizedConfig:o,kpiSnapshot:r},s.history.cost.opt.push(n.totals.cost),s.history.emissions.opt.push(n.totals.emissions),s.history.cost.opt.length>14&&s.history.cost.opt.shift(),s.history.emissions.opt.length>14&&s.history.emissions.opt.shift(),i.advisorBody&&(i.advisorBody.innerHTML=`
      <div class="advisor-item">
        <div class="advisor-headline"><span>Optimal setup found</span><span class="advisor-why">Deterministic search</span></div>
        <div class="advisor-rationale">
          Baseline score ${t.score} \u2192 Optimized score ${n.score}. Current setup is unchanged; review KPI comparison.
        </div>
      </div>
    `),i.indicator?.classList.add("hidden"),_("optimize_action")},ei=()=>{if(!s.optimized?.optimizedConfig)return;let e=F(s.optimized.optimizedConfig);s.supplierAssignments=e.supplierAssignments,s.buffers=e.buffers,s.netFlowInputs=e.netFlowInputs,s.finalDemand=e.finalDemand,s.periodDays=e.periodDays,i.demandRange&&(i.demandRange.value=`${s.finalDemand}`),i.demandInput&&(i.demandInput.value=`${s.finalDemand}`),i.periodDaysInput&&(i.periodDaysInput.value=`${s.periodDays}`),J(),_("apply_optimized")},Ce=(e,t)=>{i.roundStatus.textContent=t,i.roundStatus.className=`round-status ${e}`},Be=e=>{i.endRoundBtn.disabled=!e,i.optimizeBtn.disabled=!e,i.startRoundBtn.disabled=!1,i.supplierList?.querySelectorAll("input[data-supplier]").forEach(n=>{n.disabled=!e}),[i.inspectorBuffered,i.inspectorOnHand,i.inspectorOpenSupply,i.demandRange,i.demandInput,i.periodDaysInput].filter(Boolean).forEach(n=>{n.disabled=!e})},ti=()=>{s.roundActive=!0,Be(!0),Ce("running","Round: Running"),_("round_start")},ii=()=>{let e=N(),t=ge(e),n=Ge(t);s.roundActive=!1,Be(!1),Ce("ended","Round: Ended"),gt({title:`Board approval: ${n.label}`,body:`Score ${t} (${vt(ze(t))}) \xB7 Cost ${Q(e.cost)} \xB7 CO\u2082 ${f(e.emissions)} kg \xB7 Reliability ${f(e.reliability)}% \xB7 Service LT ${f(e.serviceLead)} days`,primaryText:"Play Again",secondaryText:"Change Scenario",onPrimary:()=>{de(),Se(),s.roundActive=!0,Be(!0),Ce("running","Round: Running"),_("round_start")},onSecondary:()=>{de(),i.scenarioModal.classList.remove("hidden"),i.scenarioModal.querySelector(".modal-scenario")?.focus()}})},ni=()=>{let e={};ke?.tooltips&&ke.tooltips.forEach(n=>{e[n.id]=n.text});let t=null;document.body.addEventListener("pointerover",n=>{let o=n.target.closest("[data-tip], [data-tooltip-id]");if(!o||o===t||o.closest("#supplierList"))return;t=o;let r=o.getAttribute("data-tooltip-id"),a=r&&e[r]||o.getAttribute("data-tip");i.tooltip.textContent=a||"",i.tooltip.classList.add("visible")}),document.body.addEventListener("pointermove",n=>{t&&(i.tooltip.style.left=`${n.clientX+14}px`,i.tooltip.style.top=`${n.clientY+14}px`)}),document.body.addEventListener("pointerout",n=>{n.target.closest("[data-tip], [data-tooltip-id]")&&(t=null,i.tooltip.classList.remove("visible"))})},Pe=[{target:null,title:"Welcome",body:"Choose a BOM scenario, set final demand, assign suppliers, and position DDMRP buffers."},{target:"bomPanel",title:"BOM + demand",body:"Final demand drives all node requirements through BOM explosion."},{target:"nodeInspector",title:"Node DDMRP controls",body:"Toggle buffer positioning at a node and simulate on-hand/open-supply to see net flow status."},{target:"supplierPanel",title:"Supplier choices",body:"Purchased nodes allow multi-sourcing with equal split. Longest supplier lead time governs node lead time."},{target:"bufferPanel",title:"Buffer posture",body:"Posture bar aggregates total red/yellow/green zones over all nodes."},{target:"dashboardPanel",title:"Optimization dashboard",body:"Cost/emissions/reliability/lead/score update live from BOM + DDMRP settings."}],R={active:!1,step:0,lastFocus:null},x={root:l("tour"),highlight:l("tourHighlight"),step:l("tourStep"),title:l("tourTitle"),body:l("tourBody"),back:l("tourBack"),next:l("tourNext"),skip:l("tourSkip")},si=e=>{if(!e){x.highlight.style.left="50%",x.highlight.style.top="40%",x.highlight.style.width="1px",x.highlight.style.height="1px";return}let t=l(e);if(!t)return;let n=t.getBoundingClientRect(),o=8;x.highlight.style.left=`${Math.max(8,n.left-o)}px`,x.highlight.style.top=`${Math.max(8,n.top-o)}px`,x.highlight.style.width=`${Math.min(window.innerWidth-16,n.width+o*2)}px`,x.highlight.style.height=`${Math.min(window.innerHeight-16,n.height+o*2)}px`},Ye=()=>{let e=Pe[R.step];x.step.textContent=`Step ${R.step+1} of ${Pe.length}`,x.title.textContent=e.title,x.body.textContent=e.body,x.back.disabled=R.step===0,x.next.textContent=R.step===Pe.length-1?"Finish":"Next",si(e.target)},oi=()=>{R.active=!0,R.step=0,R.lastFocus=document.activeElement,x.root.classList.remove("hidden"),Ye(),x.next.focus()},He=(e=!0)=>{if(R.active=!1,x.root.classList.add("hidden"),e)try{localStorage.setItem("ddmrp_tour_seen","1")}catch{}R.lastFocus&&typeof R.lastFocus.focus=="function"&&R.lastFocus.focus()},ri=()=>{i.supplierList.addEventListener("change",e=>{let t=e.target.closest("input[data-supplier]");t&&Kt(t.dataset.supplier)}),yt.forEach(e=>e.addEventListener("click",()=>ht(Number(e.dataset.scenario)))),document.querySelectorAll(".modal-scenario").forEach(e=>{e.addEventListener("click",()=>{ht(Number(e.dataset.scenario)),i.scenarioModal.classList.add("hidden")})}),i.inspectorBuffered.addEventListener("change",e=>Zt({buffered:!!e.target.checked})),i.inspectorOnHand.addEventListener("input",e=>{let t=Number(e.target.value);i.inspectorOnHandValue.textContent=`${t}%`,mt({onHandPct:t})}),i.inspectorOpenSupply.addEventListener("input",e=>{let t=Number(e.target.value);i.inspectorOpenSupplyValue.textContent=`${t}%`,mt({openSupplyPct:t})}),i.demandRange.addEventListener("input",e=>ft(Number(e.target.value))),i.demandInput.addEventListener("change",e=>ft(Number(e.target.value))),i.periodDaysInput.addEventListener("change",e=>Qt(Number(e.target.value))),i.nodeSearch&&i.nodeSearch.addEventListener("input",e=>Xt(e.target.value)),i.advisorToggle&&i.advisorToggle.addEventListener("change",e=>{s.advisor.enabled=e.target.checked,_("toggle")}),i.startRoundBtn.addEventListener("click",ti),i.endRoundBtn.addEventListener("click",ii),i.optimizeBtn.addEventListener("click",Jt),i.applyOptimizedBtn&&i.applyOptimizedBtn.addEventListener("click",ei),l("scenarioClose").addEventListener("click",()=>i.scenarioModal.classList.add("hidden")),i.tutorialBtn.addEventListener("click",()=>Wt()),i.startTourBtn&&i.startTourBtn.addEventListener("click",()=>{Te(),oi()}),i.inspectorAccordion&&i.inspectorAccordion.addEventListener("click",()=>{s.layout.userInspectorChoice=!0;let e=!s.layout.inspectorCollapsed;Bt(e)}),i.zoomInBtn&&i.zoomInBtn.addEventListener("click",()=>Ie(s.ui.zoomLevel+pe)),i.zoomOutBtn&&i.zoomOutBtn.addEventListener("click",()=>Ie(s.ui.zoomLevel-pe)),i.zoomResetBtn&&i.zoomResetBtn.addEventListener("click",Yt),i.bomSvg&&(i.bomSvg.addEventListener("wheel",e=>{e.preventDefault();let t=e.deltaY>0?s.ui.zoomLevel-pe:s.ui.zoomLevel+pe;Ie(t)},{passive:!1}),i.bomSvg.addEventListener("mousedown",e=>{s.ui.bomDragStart={clientX:e.clientX,clientY:e.clientY},s.ui.bomDidPan=!1,i.bomSvg.classList.add("bom-dragging")}),i.bomSvg.addEventListener("mousemove",e=>{let t=s.ui.bomDragStart;if(!t)return;let n=e.clientX-t.clientX,o=e.clientY-t.clientY;(Math.abs(n)>2||Math.abs(o)>2)&&(s.ui.bomDidPan=!0);let r=i.bomSvg.getBoundingClientRect(),a=s.ui.zoomLevel,d=P.w/a,c=P.h/a;r.width>0&&r.height>0&&(s.ui.panX+=n*(d/r.width),s.ui.panY+=o*(c/r.height),Oe()),s.ui.bomDragStart={clientX:e.clientX,clientY:e.clientY}}),i.bomSvg.addEventListener("mouseup",()=>{s.ui.bomDragStart=null,i.bomSvg.classList.remove("bom-dragging")}),i.bomSvg.addEventListener("mouseleave",()=>{s.ui.bomDragStart=null,i.bomSvg.classList.remove("bom-dragging")})),ve&&i.runTestsBtn&&i.runTestsBtn.addEventListener("click",St),x.back.addEventListener("click",()=>{R.step=Math.max(0,R.step-1),Ye()}),x.next.addEventListener("click",()=>{R.step===Pe.length-1?He(!0):(R.step+=1,Ye())}),x.skip.addEventListener("click",()=>He(!0)),i.modalPrimary.addEventListener("click",()=>{typeof s.modalHandlers.primary=="function"?s.modalHandlers.primary():de()}),i.modalSecondary.addEventListener("click",()=>{typeof s.modalHandlers.secondary=="function"?s.modalHandlers.secondary():de()}),i.modal.addEventListener("click",e=>{e.target===i.modal&&de()}),i.scenarioModal.addEventListener("click",e=>{e.target===i.scenarioModal&&i.scenarioModal.classList.add("hidden")}),document.addEventListener("keydown",e=>{e.key==="Escape"&&(i.modal.classList.contains("hidden")?i.scenarioModal.classList.contains("hidden")?R.active&&He(!0):i.scenarioModal.classList.add("hidden"):de(),Te())}),document.addEventListener("click",e=>{e.target.closest("#tutorialPopover")||e.target.closest("#tutorialBtn")||Te()}),window.addEventListener("resize",Et)},ai=()=>{ve&&i.validityPanel&&i.validityPanel.classList.remove("hidden"),We(),Ct(),i.advisorToggle&&(s.advisor.enabled=i.advisorToggle.checked),Se(),Xe(),Be(!1),Ce("not-started","Round: Not started"),_(),ve&&St(),ni(),ri(),Et(),Oe(),Te()};ai();})();
